# -*- coding: utf-8 -*-
import django

django.setup()

from applications.vcs.models import Commit
from applications.testing.models import TestSuite, TestRun, Test
from applications.ml.network import *


from applications.ml.models import MLModel


# test_suites = TestSuite.objects.filter(project_id__in=[426, 469]).distinct().order_by("project_id")
# for test_suite in test_suites:
#     MLModel.create_sequence(test_suite_id=test_suite.id)
#
#
# ml_model_queryset = MLModel.objects.filter(
#     test_suite__project_id__in=[
#         426,
#         469
#     ],
#     test_suite_id__in=[346]
#
# ).order_by("test_suite", "index", "updated")[:10]
#
#
# for ml_model in ml_model_queryset:
#     ml_model.save()
#     try:
#         print(f"Prepare <TestSuite: {ml_model.test_suite.id}>")
#         result = ml_model.prepare()
#         print(f"<TestSuite: {ml_model.test_suite.id}> - {result}")
#     except Exception as e:
#         print(f"<TestSuite: {ml_model.test_suite.id}> - {e}")
#         continue

# ml_model = MLModel.objects.get(test_suite_id=346, index=4)
# result = ml_model.train()



sql = """
WITH
vc_id AS (SELECT unnest(array[730940, 730942]) AS vc_id),
test_ids AS (SELECT unnest(array[92325, 92326, 92327, 92328, 92329, 92330, 92331, 91443, 92332, 91743, 91744, 91745, 91746, 91747, 91748, 91749, 91750, 91751, 91752, 91753, 91754, 91755, 91756, 91757, 91758, 91759, 91760, 91761, 91762, 91763, 91764, 91765, 91766, 91767, 91768, 91769, 91770, 91771, 91772, 91773, 92039, 92040, 92041, 92042, 92043, 92044, 92045, 92046, 92047, 92048, 92049, 92050, 92051, 92052, 92053, 92054, 92055, 92056, 92057, 92058, 92059, 92060, 92061, 92062, 92063, 92064, 92065, 92066, 92067, 92068, 92069, 92070, 92071, 92072, 91920, 84520, 84521, 84522, 84523, 84524, 84525, 84526, 84527, 84528, 84529, 84530, 82558, 91987, 91965, 91966, 91967, 91968, 91969, 91970, 91971, 91972, 91973, 91974, 91975, 91976, 91977, 91978, 91979, 91980, 91981, 91982, 91995, 91996, 91998, 92345, 91999, 92323, 92400, 86183, 82966, 82967, 82968, 82969, 82970, 82971, 82972, 82973, 82974, 82989, 82992, 83000, 83002, 83027, 84458, 83036, 83037, 83038, 83039, 83040, 83041, 83042, 83043, 83044, 83045, 83046, 83047, 83048, 83049, 83050, 83051, 83052, 83053, 83054, 83055, 83056, 83057, 83058, 83059, 83060, 83061, 83062, 83063, 83067, 83181, 83227, 83228, 83173, 83389, 83387, 83388, 86221, 86249, 85756, 86267, 86268, 86269, 86270, 86271, 86272, 86273, 86274, 86468, 58009, 58010, 58011, 60361, 60425, 60489, 59915, 59844, 59854, 59855, 59856, 59857, 59858, 59859, 59860, 59861, 59874, 59875, 59885, 59886, 59887, 59888, 59895, 59896, 59897, 59898, 59907, 59913, 59914, 59916, 59917, 59918, 59919, 59920, 59931, 59932, 59934, 59935, 59936, 59937, 59950, 59955, 59956, 59957, 59958, 59959, 59960, 59961, 59962, 59966, 59967, 59974, 59975, 59976, 59977, 60370, 60133, 60140, 60141, 60142, 60143, 60144, 60145, 60146, 60151, 60152, 60153, 60154, 60161, 60169, 60175, 60180, 60190, 60196, 60200, 60208, 60219, 60226, 60228, 60234, 60240, 60247, 60252, 60257, 60258, 60363, 60364, 60262, 60270, 60276, 60282, 60288, 60299, 60304, 60305, 60306, 60309, 60310, 60311, 60312, 60319, 60320, 60321, 60322, 60327, 60333, 60339, 60344, 60350, 60355, 60375, 60379, 60381, 60384, 60385, 60389, 60392, 60396, 60401, 60404, 60407, 60409, 60410, 60411, 60412, 60415, 60416, 60417, 60418, 60421, 60423, 60424, 60426, 60430, 60434, 60436, 60439, 60441, 60444, 60449, 60452, 60456, 60457, 60460, 60465, 60467, 60471, 60472, 60473, 60474, 60478, 60479, 60482, 60486, 60488, 60492, 60493, 60495, 60497, 60498, 60499, 60500, 60502, 60503, 60504, 60505, 60507, 60509, 60510, 60511, 60512, 60514, 60515, 60517, 60519, 60520, 60521, 60522, 60525, 60527, 60529, 60532, 60533, 60535, 60537, 60540, 60541, 60542, 60543, 60544, 60547, 60548, 60549, 60552, 60554, 60556, 60559, 60560, 60562, 60564, 60565, 60566, 60567, 60570, 60571, 60572, 60573, 60574, 60575, 60576, 60578, 60579, 60580, 60581, 60583, 60586, 60588, 60590, 60593, 60594, 60596, 60598, 60601, 60603, 60604, 60606, 60609, 60611, 60613, 60616, 60617, 60619, 60621, 60622, 60625, 60627, 80305, 80306, 80307, 80308, 80309, 80310, 80311, 80312, 80313, 80314, 70668, 70729, 70882, 70883, 70884, 70949, 71489, 71490, 71491, 71492, 71493, 68747, 68713, 68714, 68719, 68720, 68730, 68735, 68737, 68738, 68751, 68752, 68753, 68754, 68755, 68756, 68762, 68771, 68775, 68776, 68777, 68782, 68783, 68787, 68788, 68789, 68790, 68791, 68799, 68806, 71494, 68807, 68813, 68814, 68815, 68822, 68828, 68834, 68840, 68846, 68847, 68851, 68852, 68853, 68861, 68862, 68865, 68868, 68869, 68870, 68871, 68872, 68873, 68883, 68890, 68895, 68896, 68897, 69220, 69225, 69226, 69227, 69228, 69229, 69235, 69236, 69241, 69242, 69243, 69244, 69248, 69249, 69250, 69254, 69262, 69263, 69264, 69265, 69266, 69271, 69281, 69282, 69283, 69284, 69288, 69292, 69293, 69294, 69295, 69296, 69303, 69304, 69305, 69306, 69312, 69313, 69314, 69316, 69321, 69324, 69325, 69326, 69327, 69328, 69334, 69335, 69336, 69337, 69341, 69342, 69343, 69344, 69353, 69354, 69355, 69361, 69362, 69369, 69370, 69371, 69373, 69374, 69380, 69381, 69382, 69383, 69389, 69390, 69391, 69399, 69401, 69402, 69403, 69404, 69405, 69413, 69414, 69419, 69424, 69426, 69429, 69430, 69431, 69432, 69440, 69447, 69449, 69450, 69451, 69454, 69463, 69464, 69465, 69469, 69476, 69477, 69478, 69479, 69480, 69482, 69483, 69484, 69485, 69494, 69497, 69498, 69499, 69500, 69506, 69507, 69509, 69513, 69516, 69521, 69522, 69523, 69524, 69525, 69531, 69532, 69533, 69534, 69537, 69541, 69549, 69550, 69551, 69557, 69566, 69567, 69568, 69571, 69576, 69583, 69588, 69593, 69594, 69595, 69649, 69596, 69597, 69600, 69603, 69604, 69605, 69606, 69607, 69608, 69618, 69623, 69624, 69625, 69626, 69627, 69635, 69636, 69637, 69644, 69645, 69650, 69657, 69658, 69664, 69665, 69666, 69667, 69678, 69680, 69686, 69687, 69694, 69695, 69700, 69701, 69702, 69703, 69711, 69712, 69713, 69714, 69722, 69729, 69730, 69734, 69737, 69738, 69748, 69751, 69757, 69758, 69760, 69761, 69762, 69763, 69764, 69768, 69772, 69773, 69774, 69775, 69776, 69777, 69781, 69785, 69786, 69787, 69788, 69789, 69790, 69803, 69804, 69808, 69809, 69810, 69811, 69812, 69813, 69814, 69815, 69816, 69817, 69818, 69819, 69820, 69826, 69827, 69828, 69829, 69830, 69831, 69832, 69833, 69834, 69835, 69836, 69837, 69838, 69839, 69861, 69840, 69841, 69842, 69843, 69844, 69845, 69846, 69847, 69848, 69849, 69850, 69851, 69852, 69853, 69854, 69856, 69857, 69858, 69859, 69860, 69862, 69863, 69867, 69868, 69869, 69870, 69871, 69872, 69873, 69874, 69875, 69879, 69880, 69881, 69882, 69883, 69884, 69885, 69886, 69887, 69888, 69889, 69890, 69891, 69892, 69893, 69897, 69898, 69899, 69900, 69901, 69902, 69903, 69904, 69905, 69906, 69907, 69908, 69909, 69910, 69911, 69912, 69913, 69914, 69915, 69916, 69917, 69918, 69919, 69920, 69921, 69922, 69923, 69924, 69925, 69926, 69927, 69928, 69929, 69930, 69934, 69935, 69936, 69937, 69939, 69940, 69942, 69948, 69949, 69950, 69951, 69952, 69955, 69960, 69961, 69962, 69963, 69964, 69965, 69967, 69970, 69971, 69972, 69973, 69974, 69977, 69978, 69979, 69985, 69986, 69988, 69989, 69992, 69993, 69994, 69995, 70004, 70011, 70013, 70014, 70021, 70022, 70026, 70027, 70028, 70029, 70040, 70041, 70042, 70043, 70048, 70050, 70117, 70056, 70057, 70062, 70069, 70072, 70076, 70087, 70088, 70092, 70099, 70100, 70101, 70102, 70103, 70107, 70112, 70113, 70114, 70115, 70116, 70122, 70127, 70128, 70129, 70130, 70131, 70137, 70138, 70139, 70140, 70141, 70145, 70146, 70150, 70151, 70152, 70153, 70157, 70164, 70170, 70171, 70173, 70174, 70177, 70178, 70180, 70182, 70191, 70193, 70195, 70196, 70201, 70202, 70207, 70209, 70215, 70219, 70227, 70229, 70236, 70465, 70240, 70242, 70249, 70250, 70251, 70252, 70253, 70259, 70263, 70264, 70265, 70266, 70267, 70268, 70273, 70275, 70276, 70277, 70278, 70279, 70282, 70283, 70284, 70290, 70291, 70292, 70293, 70298, 70299, 70300, 70301, 70305, 70309, 70310, 70311, 70313, 70314, 70317, 70318, 70319, 70320, 70326, 70327, 70328, 70329, 70332, 70335, 70338, 70339, 70345, 70346, 70349, 70351, 70352, 70355, 70361, 70362, 70363, 70364, 70365, 70366, 70368, 70372, 70373, 70374, 70375, 70376, 70377, 70381, 70385, 70386, 70387, 70388, 70389, 70390, 70391, 70392, 70396, 70397, 70398, 70399, 70400, 70401, 70402, 70403, 70404, 70405, 70406, 70407, 70408, 70409, 70411, 70412, 70413, 70414, 70417, 70418, 70419, 70420, 70421, 70427, 70429, 70430, 70434, 70435, 70438, 70444, 70445, 70447, 70451, 70455, 70456, 70457, 70458, 70459, 70460, 70463, 70464, 70466, 70467, 70468, 70474, 70476, 70477, 70478, 70479, 70480, 70484, 70485, 70486, 70490, 70491, 70495, 70496, 70497, 70498, 70499, 70500, 70501, 70505, 70506, 70507, 70508, 70509, 70510, 70511, 70512, 70513, 70514, 70515, 70516, 70517, 70518, 70519, 70521, 70524, 70525, 70526, 70527, 70533, 70535, 70536, 70537, 70538, 70539, 70540, 70541, 70548, 70549, 70553, 70554, 70555, 70556, 70557, 70558, 70562, 70563, 70564, 70565, 70566, 70567, 70568, 70569, 70570, 70571, 70572, 70573, 70574, 70582, 70583, 70588, 70592, 70596, 70597, 70601, 70602, 70603, 70604, 70605, 70606, 70607, 70608, 70609, 70610, 70611, 70612, 70613, 70614, 70615, 70616, 70617, 70618, 70619, 70620, 70621, 70622, 70623, 70624, 70625, 70626, 70627, 70628, 70646, 70629, 70630, 70631, 70632, 70633, 70634, 70635, 70636, 70637, 70638, 70639, 70640, 70641, 70642, 70643, 70644, 70645, 70647, 70648, 70649, 70650, 70651, 70652, 70653, 70654, 70655, 70656, 70657, 70658, 70659, 70660, 70661, 70662, 70663, 70664, 70665, 70666, 70667, 70669, 70670, 70671, 70672, 70673, 70674, 70675, 70676, 70677, 70678, 70679, 70680, 70681, 70682, 70683, 70684, 70685, 70686, 70687, 70688, 70689, 70690, 70691, 70692, 70693, 70694, 70695, 70696, 70697, 70698, 70699, 70700, 70701, 70702, 70703, 70704, 70705, 70706, 70730, 70707, 70708, 70709, 70710, 70711, 70712, 70713, 70714, 70715, 70716, 70717, 70718, 70719, 70720, 70721, 70722, 70723, 70724, 70725, 70726, 70727, 70728, 70731, 70732, 70733, 70734, 70735, 70736, 70737, 70738, 70739, 70740, 70741, 70742, 70743, 70744, 70745, 70746, 70747, 70748, 70749, 70750, 70751, 70752, 70753, 70754, 70755, 70756, 70757, 70758, 70759, 70760, 70761, 70762, 70763, 70764, 70765, 70766, 70767, 70768, 70769, 70770, 70771, 70772, 70773, 70774, 70775, 70776, 70777, 70778, 70779, 70780, 70781, 70782, 70783, 70784, 70785, 70786, 70787, 70788, 70789, 70790, 70791, 70792, 70793, 70814, 70794, 70795, 70796, 70797, 70798, 70799, 70800, 70801, 70802, 70803, 70804, 70805, 70806, 70807, 70808, 70809, 70810, 70811, 70812, 70813, 70815, 70816, 70817, 70818, 70819, 70820, 70821, 70822, 70823, 70824, 70825, 70826, 70827, 70828, 70829, 70830, 70831, 70832, 70833, 70834, 70835, 70836, 70837, 70838, 70839, 70840, 70841, 70842, 70843, 70844, 70845, 70846, 70847, 70848, 70849, 70850, 70851, 70852, 70853, 70854, 70855, 70856, 70857, 70858, 70881, 70859, 70860, 70861, 70862, 70863, 70864, 70865, 70866, 70867, 70868, 70869, 70870, 70871, 70872, 70873, 70874, 70875, 70876, 70877, 70878, 70879, 70880, 70885, 70886, 70887, 70888, 70889, 70890, 70891, 70892, 70893, 70894, 70895, 70896, 70897, 70898, 70899, 70900, 70901, 70902, 70903, 70904, 70905, 70906, 70907, 70908, 70909, 70910, 70911, 70912, 70913, 70914, 70915, 70916, 70917, 70918, 70919, 70920, 70921, 70922, 70923, 70924, 70925, 70926, 70927, 70928, 70929, 70930, 70931, 70932, 70933, 70934, 70935, 70936, 70937, 70938, 70939, 70940, 70941, 70942, 70943, 70944, 70945, 70946, 70947, 70948, 70950, 70951, 70952, 70953, 70954, 70955, 70956, 70957, 70958, 70959, 70960, 70961, 70962, 70963, 70964, 70965, 70966, 70967, 70968, 70969, 70970, 70971, 70972, 70973, 70974, 70975, 70976, 70977, 70978, 70979, 70980, 70981, 70982, 70983, 70984, 70985, 70986, 70987, 70988, 70989, 71048, 70990, 70991, 70992, 70993, 70994, 70995, 70996, 70997, 70998, 70999, 71000, 71001, 71002, 71003, 71004, 71005, 71006, 71007, 71008, 71009, 71010, 71011, 71012, 71013, 71014, 71015, 71016, 71017, 71018, 71019, 71020, 71021, 71022, 71023, 71024, 71025, 71026, 71027, 71047, 71028, 71029, 71030, 71031, 71032, 71033, 71034, 71035, 71036, 71037, 71038, 71039, 71040, 71041, 71042, 71043, 71044, 71045, 71046, 71049, 71050, 71051, 71052, 71053, 71054, 71055, 71056, 71057, 71058, 71059, 71060, 71061, 71062, 71063, 71064, 71065, 71066, 71067, 71068, 71069, 71070, 71071, 71072, 71073, 71074, 71075, 71076, 71077, 71078, 71079, 71080, 71081, 71082, 71083, 71084, 71085, 71086, 71087, 71088, 71089, 71090, 71091, 71092, 71093, 71094, 71095, 71096, 71097, 71098, 71099, 71100, 71101, 71102, 71103, 71104, 71105, 71106, 71107, 71108, 71109, 71110, 71111, 71211, 71112, 71113, 71114, 71115, 71116, 71117, 71118, 71119, 71120, 71121, 71122, 71123, 71124, 71125, 71126, 71127, 71128, 71129, 71130, 71131, 71132, 71133, 71134, 71135, 71136, 71137, 71138, 71139, 71140, 71141, 71142, 71143, 71144, 71145, 71146, 71147, 71148, 71149, 71150, 71151, 71152, 71153, 71154, 71155, 71156, 71157, 71158, 71159, 71160, 71161, 71162, 71163, 71164, 71165, 71166, 71167, 71168, 71169, 71170, 71171, 71172, 71173, 71174, 71175, 71176, 71177, 71178, 71179, 71180, 71181, 71182, 71183, 71184, 71185, 71186, 71187, 71188, 71189, 71190, 71210, 71191, 71192, 71193, 71194, 71195, 71196, 71197, 71198, 71199, 71200, 71201, 71202, 71203, 71204, 71205, 71206, 71207, 71208, 71209, 71212, 71213, 71214, 71215, 71216, 71217, 71218, 71219, 71220, 71221, 71222, 71223, 71224, 71225, 71226, 71227, 71228, 71229, 71230, 71231, 71232, 71233, 71234, 71235, 71236, 71237, 71238, 71239, 71240, 71241, 71242, 71243, 71244, 71245, 71246, 71247, 71248, 71249, 71250, 71251, 71252, 71253, 71254, 71255, 71256, 71257, 71258, 71259, 71260, 71261, 71262, 71263, 71264, 71265, 71266, 71267, 71268, 71269, 71270, 71271, 71272, 71273, 71274, 71275, 71276, 71277, 71278, 71279, 71280, 71281, 71282, 71283, 71284, 71285, 71286, 71287, 71288, 71289, 71290, 71291, 71292, 71293, 71294, 71295, 71296, 71297, 71298, 71299, 71300, 71301, 71302, 71303, 71304, 71305, 71306, 71307, 71308, 71458, 71309, 71310, 71311, 71312, 71313, 71314, 71315, 71316, 71317, 71318, 71319, 71320, 71321, 71322, 71323, 71324, 71325, 71326, 71327, 71328, 71329, 71330, 71331, 71332, 71333, 71334, 71335, 71336, 71337, 71338, 71339, 71340, 71341, 71342, 71343, 71344, 71345, 71346, 71347, 71348, 71349, 71350, 71351, 71352, 71353, 71354, 71355, 71356, 71357, 71358, 71359, 71360, 71361, 71362, 71363, 71364, 71365, 71366, 71367, 71459, 71368, 71369, 71370, 71371, 71372, 71373, 71374, 71375, 71376, 71377, 71378, 71379, 71380, 71381, 71382, 71383, 71384, 71385, 71386, 71387, 71388, 71487, 71389, 71390, 71391, 71392, 71393, 71394, 71395, 71396, 71397, 71398, 71399, 71400, 71401, 71402, 71403, 71404, 71405, 71406, 71407, 71408, 71409, 71410, 71411, 71412, 71413, 71414, 71415, 71416, 71417, 71418, 71419, 71420, 71421, 71422, 71423, 71424, 71425, 71426, 71427, 71428, 71429, 71430, 71431, 71432, 71433, 71434, 71435, 71436, 71437, 71438, 71439, 71440, 71441, 71442, 71443, 71444, 71445, 71446, 71447, 71448, 71449, 71450, 71451, 71452, 71453, 71454, 71455, 71456, 71457, 71488, 71460, 71461, 71462, 71463, 71464, 71465, 71466, 71467, 71468, 71469, 71470, 71471, 71472, 71473, 71474, 71475, 71476, 71477, 71478, 71479, 71480, 71481, 71482, 71483, 71484, 71485, 71486, 71495, 71496, 71497, 71498, 71499, 71500, 71501, 71502, 71503, 72594, 72595, 72649, 78565, 78566, 78567, 78568, 78569, 78570, 78571, 78572, 78573, 78574, 78575, 78576, 78577, 78578, 78579, 78580, 78581, 78582, 78583, 78584, 78585, 78586, 78587, 78588, 78589, 78590, 78591, 78592, 78593, 78594, 78595, 78596, 78597, 78598, 78599, 78600, 78601, 78602, 78603, 78604, 78605, 78606, 78607, 78608, 78609, 78610, 78611, 78612, 78613, 78614, 78615, 78616, 78617, 78618, 78619, 78620, 78621, 78622, 78623, 78624, 78625, 78626, 78627, 78628, 78629, 78630, 78631, 78632, 78633, 78634, 78635, 78636, 78637, 78638, 78639, 78640, 78641, 78642, 78643, 78644, 78645, 78646, 78647, 78648, 78649, 78650, 78651, 78652, 78653, 78654, 78655, 78656, 78657, 78658, 78659, 78660, 78661, 78662, 78663, 78664, 78665, 78666, 78667, 78668, 78669, 78670, 78671, 78672, 78673, 78674, 78675, 78676, 78677, 78678, 78679, 78680, 78681, 78682, 78683, 78684, 78685, 78686, 78687, 78688, 78689, 78690, 78691, 78692, 78693, 78694, 78695, 78696, 78697, 78698, 78699, 78700, 78701, 78702, 78703, 78704, 78705, 78706, 78707, 78708, 78709, 78710, 78711, 78712, 78713, 78714, 78715, 78716, 78717, 78718, 78719, 78720, 78721, 78722, 78723, 78724, 78725, 78726, 78727, 78728, 78729, 78730, 78731, 78732, 78733, 78734, 78735, 78736, 78737, 78738, 78739, 78740, 78741, 78742, 78743, 78744, 78745, 78746, 78747, 78748, 78749, 78750, 78751, 78752, 78753, 78754, 78755, 78756, 78757, 78758, 78759, 78760, 78761, 78762, 78763, 78764, 78765, 78766, 78767, 78768, 78769, 78770, 78771, 78772, 78773, 78774, 78775, 78776, 78777, 78778, 78779, 78780, 78781, 78782, 78783, 78784, 78785, 78786, 78787, 78788, 78789, 78790, 78791, 78792, 78793, 78794, 78795, 78796, 78797, 78798, 78799, 78800, 78801, 78802, 78803, 78804, 78805, 78806, 78807, 78808, 78809, 78810, 78811, 78812, 78813, 78814, 78815, 78816, 78817, 78818, 78819, 78820, 78821, 78822, 78823, 78824, 78825, 78826, 78827, 78828, 78829, 78830, 78831, 78832, 78833, 78834, 78835, 78836, 78837, 78838, 78839, 78840, 78841, 78842, 78843, 78844, 78845, 78846, 78847, 78848, 78849, 78850, 78851, 78852, 78853, 78854, 78855, 78856, 78857, 78858, 78859, 78860, 78861, 78862, 78863, 78864, 78865, 78866, 78867, 78868, 78869, 78870, 78871, 78872, 78873, 78874, 78875, 78876, 78877, 78878, 78879, 78880, 78881, 78882, 78883, 78884, 78885, 78886, 78887, 78888, 78889, 78890, 78891, 78892, 78893, 78894, 78895, 78896, 78897, 78898, 78899, 78900, 78901, 78902, 78903, 78904, 78905, 78906, 78907, 78908, 78909, 78910, 81019, 78911, 78912, 78913, 78914, 78915, 78916, 78917, 78918, 78919, 78920, 78921, 78922, 78923, 78924, 78925, 78926, 78927, 78928, 78929, 78930, 78931, 78932, 78933, 78934, 78935, 78936, 78937, 78938, 78939, 78940, 78941, 78942, 78943, 78944, 78945, 78946, 78947, 78948, 78949, 78950, 78951, 78952, 78953, 78954, 78955, 78956, 78957, 78958, 78959, 78960, 78961, 78962, 78963, 78964, 78965, 78966, 78967, 78968, 78969, 78970, 78971, 78972, 78973, 78974, 78975, 78976, 78977, 78978, 78979, 78980, 78981, 78982, 78983, 78984, 78985, 78986, 78987, 78988, 78989, 78990, 78991, 78992, 78993, 78994, 78995, 78996, 78997, 78998, 78999, 79000, 79001, 79002, 79003, 79004, 79005, 79006, 79007, 79008, 79009, 79010, 79011, 79012, 79013, 79014, 79015, 79016, 79017, 79018, 79019, 79020, 79021, 79022, 79023, 79024, 79025, 79026, 79027, 79028, 79029, 79030, 79031, 79052, 79032, 79033, 79034, 79035, 79036, 79037, 79038, 79039, 79040, 79041, 79042, 79043, 79044, 79045, 79046, 79047, 79048, 79049, 79050, 79051, 79053, 79054, 79055, 79056, 79057, 79058, 79059, 79060, 79061, 79062, 79063, 79064, 79065, 79066, 79067, 79068, 79069, 79070, 79071, 79072, 79073, 79074, 79075, 79076, 79077, 79078, 79079, 79080, 79081, 79082, 79083, 79084, 79085, 79086, 79087, 79088, 79089, 79090, 79091, 79092, 79093, 79235, 79094, 79095, 79096, 79097, 79098, 79099, 79100, 79101, 79102, 79103, 79104, 79105, 79106, 79107, 79108, 79109, 79110, 79111, 79112, 79113, 79114, 79115, 79116, 79117, 79118, 79119, 79120, 79121, 79122, 79123, 79124, 79125, 79126, 79127, 79128, 79129, 79130, 79131, 79132, 79133, 79134, 79135, 79136, 79137, 79138, 79139, 79140, 79141, 79142, 79143, 79144, 79145, 79146, 79147, 79148, 79149, 79150, 79151, 79152, 79153, 79154, 79155, 79156, 79157, 79158, 79159, 79160, 79161, 79162, 79163, 79164, 79165, 79166, 79167, 79168, 79169, 79170, 79171, 79172, 79173, 79174, 79175, 79176, 79177, 79178, 79179, 79180, 79181, 79182, 79183, 79184, 79185, 79186, 79187, 79188, 79189, 79190, 79191, 79192, 79193, 79194, 79195, 79196, 79197, 79198, 79199, 79200, 79201, 79202, 79203, 79204, 79205, 79206, 79207, 79208, 79209, 79210, 79211, 79212, 79213, 79214, 79215, 79216, 79217, 79218, 79219, 79220, 79221, 79222, 79223, 79224, 79225, 79226, 79227, 79239, 79240, 79242, 79267, 79268, 79269, 79303, 79304, 79305, 79306, 79307, 79308, 79309, 79310, 79311, 79312, 79313, 79314, 79315, 79316, 79317, 79318, 79319, 79320, 79321, 79322, 79323, 79324, 79325, 79326, 79327, 79328, 79329, 79330, 79331, 79332, 79333, 79334, 79350, 79420, 79419, 79421, 79422, 79423, 79424, 79425, 79426, 79427, 79428, 79429, 79430, 79431, 79432, 79433, 79434, 79435, 79436, 79437, 79438, 79439, 79440, 79441, 79442, 79443, 79568, 79569, 79570, 79571, 79572, 80194, 80195, 80196, 80299, 80300, 80914, 80915, 80916, 80917, 80924, 80925, 80928, 80929, 80930, 80931, 80932, 80933, 80986, 80998, 80999, 81018, 81020, 81023, 81024, 81025, 81026, 81027, 81028, 81029, 81030, 81031, 81032, 81033, 81034, 81035, 81036, 81037, 81038, 81039, 81040, 81041, 81042, 81043, 81158, 81114, 81146, 81147, 81148, 81149, 81150, 81151, 81152, 81153, 81154, 82221, 82222, 82223, 82224, 82426, 82430, 82433, 82434, 82488, 82495, 82498, 82503, 82504, 82523, 87274, 87276, 87277, 87278, 87279, 87280, 87281, 87282, 87283, 87340, 87341, 87342, 87343, 87344, 87345, 87346, 87347, 87348, 87349, 87350, 87351, 87352, 87353, 87356, 87361, 87371, 87372, 87373, 87374, 87375, 87376, 87377, 87378, 87379, 87380, 87381, 87382, 87383, 87384, 87385, 87386, 87387, 87388, 87389, 87390, 87391, 87392, 87393, 87394, 87395, 87396, 87397, 87398, 87399, 87400, 87401, 87402, 87403, 87404, 87405, 87406, 87407, 87408, 87409, 87410, 87411, 87412, 87439, 87440, 87441, 87442, 87443, 87444, 87445, 87446, 87447, 87448, 87449, 87450, 87451, 87452, 87453, 87454, 88451, 89447, 89446, 89445, 89448, 93585, 95119, 95120, 95121, 95122, 95123, 95124, 95125, 95126, 95127, 95128, 95129, 95130]) as test_id),
vc AS
(
    SELECT
        tt.id AS test_id,
        tt.project_id,
        vc.sha,
        vc.rework,
        vc.riskiness,
        va.id AS va_id,
        vc.id AS vc_id,
        tt.id AS tt_id,
        tt.name as tt_name,
        tt.class_name,
        va.name as va_name
    FROM vcs_commit vc
				INNER JOIN testing_test tt on tt.id IN (SELECT test_id FROM test_ids)
        INNER JOIN vcs_area va ON tt.area_id = va.id
    WHERE vc.id IN (SELECT vc_id FROM vc_id)
GROUP BY 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11
),
vc_grp AS (
    SELECT
        vc.test_id,
        vc.project_id,
        vc.sha,
        vc.rework,
        vc.riskiness,
    array_remove(array_agg(DISTINCT full_trim(vc.tt_name)), NULL) AS test_names,
    array_remove(array_agg(DISTINCT vc.class_name), NULL) AS test_classes_names,
    array_remove(array_agg(DISTINCT lower(vc.va_name)), NULL) AS test_areas,
    string_agg(DISTINCT vc.va_name, ' ') AS va_names,

    ARRAY [''] AS test_similarnamed,

    array_remove(array(
           SELECT lower(vcs_area.name)
           FROM vcs_area
               INNER JOIN vcs_commit_areas vca ON (vcs_area.id = vca.area_id)
           WHERE vca.commit_id IN (SELECT vc_id FROM vc_id)
					 ), NULL) AS defect_closed_by_caused_by_intersection_areas,
    array_remove(array(
           SELECT normalize_filepath_string(full_trim(vcs_file.full_filename))
           FROM vcs_file
               INNER JOIN vcs_filechange vf ON (vcs_file.id = vf.file_id)
           WHERE vf.commit_id IN (SELECT vc_id FROM vc_id)
           ), NULL) AS defect_closed_by_caused_by_intersection_files,
    array_remove(array(
           SELECT DISTINCT normalize_filepath_string(full_trim(unnest(string_to_array(rtrim(vcs_file.full_filename, vcs_file.filename), '/'))))
           FROM vcs_file
               INNER JOIN vcs_filechange vf ON (vcs_file.id = vf.file_id)
           WHERE vf.commit_id IN (SELECT vc_id FROM vc_id)
           ), NULL) AS defect_closed_by_caused_by_intersection_folders,
    array_remove(array(
           SELECT DISTINCT normalize_filepath_string(full_trim(va6.name))
           FROM vcs_commit_areas vca6
               INNER JOIN vcs_area_dependencies vad6 on vca6.area_id = vad6.from_area_id
               INNER JOIN vcs_area va6 on va6.id = vad6.to_area_id
           WHERE vca6.commit_id IN (SELECT vc_id FROM vc_id)
           ), NULL) AS defect_closed_by_caused_by_intersection_dependent_areas
FROM vc
GROUP BY vc.test_id,
         vc.project_id,
         vc.sha,
         vc.rework,
         vc.riskiness),
test_area_similarnamed AS (
SELECT vc.project_id,
         vc.test_areas,
         array_remove(test_area_similarnamed(vc.project_id, array_to_string(vc.test_areas, ' ')), NULL) AS test_area_similarnamed
FROM (SELECT project_id, test_areas FROM vc_grp GROUP BY project_id, test_areas ORDER BY 1, 2) vc
),
test_associated_areas AS (
SELECT vc.test_id,
array_remove(array_agg(DISTINCT lower(va2.name)), NULL) AS test_associated_areas
FROM vc
INNER JOIN testing_test_associated_areas ttaa2 on vc.va_id = ttaa2.area_id
INNER JOIN vcs_area va2 on ttaa2.area_id = va2.id
GROUP BY vc.test_id),
test_associated_files AS (
SELECT vc.test_id,
array_remove(normalize_filepath_string(array_agg(DISTINCT vf.full_filename)), NULL) AS test_associated_files
FROM vc
INNER JOIN testing_test_associated_files ttaf on vc.test_id = ttaf.test_id
INNER JOIN vcs_file vf on ttaf.file_id = vf.id
GROUP BY vc.test_id),
test_dependent_areas AS (
SELECT vc.test_id,
array_remove(array_agg(DISTINCT lower(va3.name)), NULL) AS test_dependent_areas
FROM vc
INNER JOIN vcs_area_dependencies vad on vc.va_id = vad.to_area_id
INNER JOIN testing_test_associated_areas ttaa3 on vad.from_area_id = ttaa3.area_id
INNER JOIN vcs_area va3 on ttaa3.area_id = va3.id
GROUP BY vc.test_id),
commit_areas AS (
SELECT vc.test_id,
array_remove(normalize_filepath_string(array_agg(DISTINCT va4.name)), NULL) AS commit_areas
FROM vc
INNER JOIN vcs_commit_areas vca4 on vc.vc_id = vca4.commit_id
INNER JOIN vcs_area va4 on vca4.area_id = va4.id
GROUP BY vc.test_id),
commit_files AS (
SELECT vc.test_id,
    array_remove(normalize_filepath_string(array_agg(DISTINCT vf2.full_filename)), NULL) AS commit_files
FROM vc
INNER JOIN vcs_filechange vfc2 on vc.vc_id = vfc2.commit_id
INNER JOIN vcs_file vf2 on vfc2.file_id = vf2.id
GROUP BY vc.test_id),
defect_caused_by_commits_files AS (
SELECT vc.test_id,
    array_remove(normalize_filepath_string(array_agg(DISTINCT vf3.full_filename)), NULL) AS defect_caused_by_commits_files
FROM vc
INNER JOIN vcs_filechange vfc3 on vfc3.commit_id = vc.vc_id
INNER JOIN vcs_file vf3 on vf3.id = vfc3.file_id
GROUP BY vc.test_id),
defect_caused_by_commits_folders AS (
SELECT t.test_id,
    array_remove(normalize_filepath_string(array_agg(DISTINCT t.folder)), NULL) AS defect_caused_by_commits_folders
FROM
(
	SELECT vc.test_id, unnest(string_to_array(rtrim(vf3.full_filename, vf3.filename), '/')) AS folder
	FROM vc
	INNER JOIN vcs_filechange vfc3 on vfc3.commit_id = vc.vc_id
	INNER JOIN vcs_file vf3 on vf3.id = vfc3.file_id
) t
GROUP BY t.test_id),
defect_caused_by_commits_areas AS (
SELECT vc.test_id,
    array_remove(array_agg(DISTINCT lower(va5.name)), NULL) AS defect_caused_by_commits_areas
FROM vc
INNER JOIN vcs_commit_areas vca5 on vca5.commit_id = vc.vc_id
INNER JOIN vcs_area va5 on vca5.area_id = va5.id
GROUP BY vc.test_id),
defect_caused_by_commits_dependent_areas AS (
SELECT vc.test_id,
    array_remove(array_agg(DISTINCT lower(va6.name)), NULL) AS defect_caused_by_commits_dependent_areas
FROM vc
INNER JOIN vcs_commit_areas vca6 on vca6.commit_id = vc.vc_id
INNER JOIN vcs_area_dependencies vad6 on vca6.area_id = vad6.from_area_id
INNER JOIN vcs_area va6 on va6.id = vad6.to_area_id
GROUP BY vc.test_id)

SELECT vc.test_id,
vc.project_id,
vc.test_names,
vc.test_classes_names,
vc.test_areas,
vc.va_names,
taa.test_associated_areas,
taf.test_associated_files,
tda.test_dependent_areas,
vc.test_similarnamed,
tasn.test_area_similarnamed,
vc.rework AS commit_rework,
vc.riskiness::numeric::integer * 100 AS commit_riskiness,
ca.commit_areas,
cf.commit_files,
dccf.defect_caused_by_commits_files,
dcca.defect_caused_by_commits_areas,
dccda.defect_caused_by_commits_dependent_areas,
vc.defect_closed_by_caused_by_intersection_areas,
vc.defect_closed_by_caused_by_intersection_files,
vc.defect_closed_by_caused_by_intersection_folders,
vc.defect_closed_by_caused_by_intersection_dependent_areas,
dccfld.defect_caused_by_commits_folders
FROM vc_grp vc
LEFT OUTER JOIN test_area_similarnamed tasn ON vc.project_id = tasn.project_id AND vc.test_areas = tasn.test_areas
LEFT OUTER JOIN test_associated_areas taa ON vc.test_id = taa.test_id
LEFT OUTER JOIN test_associated_files taf ON vc.test_id = taf.test_id
LEFT OUTER JOIN test_dependent_areas tda ON vc.test_id = tda.test_id
LEFT OUTER JOIN commit_areas ca ON vc.test_id = ca.test_id
LEFT OUTER JOIN commit_files cf ON vc.test_id = cf.test_id
LEFT OUTER JOIN defect_caused_by_commits_files dccf ON vc.test_id = dccf.test_id
LEFT OUTER JOIN defect_caused_by_commits_areas dcca ON vc.test_id = dcca.test_id
LEFT OUTER JOIN defect_caused_by_commits_dependent_areas dccda ON vc.test_id = dccda.test_id
LEFT OUTER JOIN defect_caused_by_commits_folders dccfld ON vc.test_id = dccfld.test_id
"""

sql_query = f"\copy (SELECT row_to_json(t) FROM ({sql}) t) " \
                f"To './predict.json'"

from applications.ml.database import execute_query

execute_query(sql_query)